# db (shared database library)

Scope
- Central place for database access and migrations for the workspace.
- Includes SQLAlchemy, Alembic, and the Supabase Python client.

Layout

```
libs/db/
├─ src/db/
│  ├─ __init__.py
│  ├─ client.py        # Placeholder for engine/session and Supabase helpers
│  └─ models/
│     └─ __init__.py   # Placeholder for shared ORM models or registry
├─ alembic.ini         # Alembic configuration (script_location=alembic)
└─ alembic/
   ├─ env.py           # Alembic runtime config (reads DATABASE_URL)
   └─ versions/        # Migration scripts live here
```

Notes
- No runtime logic is implemented yet—this is scaffolding only.
- Alembic reads `DATABASE_URL` from the repo‑root `.env` automatically via `env.py` (no export needed). If absent, it falls back to `sqlalchemy.url` in `libs/db/alembic.ini`.

## Alembic migrations

The `db` library owns all schema migrations for the workspace. Migrations are
managed with Alembic and live under `libs/db/alembic/versions/`.

### Prerequisites
- Python 3.12 and [uv](https://docs.astral.sh/uv/) installed
- Workspace dependencies installed: `uv sync`
- A database URL provided via either the repo‑root `.env` (preferred) or
  `libs/db/alembic.ini`'s `sqlalchemy.url`. `env.py` loads `.env` and takes
  precedence over `sqlalchemy.url`.

Example `.env` line (Postgres via psycopg v3 driver):

```env
DATABASE_URL=postgresql+psycopg://user:pass@localhost:5432/panoply
```

`libs/db/alembic/env.py` auto‑loads the root `.env` (no need to export in your
shell) and falls back to `alembic.ini` if `DATABASE_URL` is not set.

### Apply migrations (upgrade)

Run from the repo root (pass the config path):

```bash
uv run alembic -c libs/db/alembic.ini upgrade head
```

Or run from inside `libs/db/` (config auto‑discovered):

```bash
cd libs/db
uv run alembic upgrade head
```

Useful status commands:

```bash
# Show current DB revision
uv run alembic -c libs/db/alembic.ini current

# Show history and indicate the current head
uv run alembic -c libs/db/alembic.ini history --indicate-current

# Show a specific revision's details
uv run alembic -c libs/db/alembic.ini show 0003
```

Note: Always use the full zero‑padded `rev_id` (e.g., `0003`) in Alembic
commands to avoid ambiguous matches.

Downgrades (use sparingly in shared environments):

```bash
# Revert one migration
uv run alembic -c libs/db/alembic.ini downgrade -1

# Revert to a specific revision
uv run alembic -c libs/db/alembic.ini downgrade 0002
```

Generate SQL instead of applying (offline mode):

```bash
uv run alembic -c libs/db/alembic.ini upgrade head --sql > /tmp/upgrade.sql
```

### Create a new migration

We use a zero‑padded numeric revision identifier (`rev_id`) instead of
Alembic's random hashes. The human‑readable slug in the filename comes from the
`-m` message. Example: `rev_id=0004`, message "Add X" → file
`libs/db/alembic/versions/0004_add_x.py`. This assumes the default Alembic
`file_template = %(rev)s_%(slug)s` in `libs/db/alembic.ini`.

1) Pick the next revision number. List existing files under
   `libs/db/alembic/versions/` and increment the highest prefix.

2) Create the revision file (message is free‑form; keep it short):

```bash
# From repo root
uv run alembic -c libs/db/alembic.ini \
  revision -m "Add X" --rev-id 0004
```

This creates `libs/db/alembic/versions/0004_add_x.py` with `upgrade()` and
`downgrade()` functions. Edit them to apply the change. Follow existing
conventions (explicit indexes, deferrable FKs, CHECK constraints where
appropriate).

Optional: once ORM models exist in `db` and expose `metadata`, you can ask
Alembic to autogenerate diffs:

```bash
uv run alembic -c libs/db/alembic.ini revision --autogenerate -m "Sync models"
```

Always review autogenerated scripts and adjust as needed.

### Troubleshooting
- Error: `DATABASE_URL is not set` → Copy `.env.example` to `.env` and fill in
  `DATABASE_URL` (or set it in the shell), or set `sqlalchemy.url` in
  `libs/db/alembic.ini`. Re‑run the command.
- Warning about `db.metadata` import during autogenerate → Safe to ignore for
  SQL‑only migrations; it only affects model‑diff generation.

## Finance domain schema (public)

The following tables are owned by this library and are created by Alembic migrations:

- `fa_categories`
  - `code text primary key`
  - `display_name text not null unique`
  - `is_active boolean not null default true`
  - `sort_order integer null`
  - `created_at timestamptz not null default now()`
  - `updated_at timestamptz not null default now()`

- `fa_transactions`
  - `id bigint primary key generated always as identity`
  - `source_provider text not null`
  - `source_account text null`
  - `external_id text null`
  - `fingerprint_sha256 char(64) not null unique`
  - `raw_record jsonb not null`
  - `currency_code char(3) not null default 'USD'`
  - `amount numeric(18,2) null`
  - `date date null`
  - `description text null`
  - `merchant text null`
  - `memo text null`
  - `verified boolean not null default false`
  - `category text null references fa_categories(code) deferrable initially deferred`
  - `category_source text not null default 'unknown'` with `CHECK (category_source in ('llm','manual','rule','import','unknown'))`
  - `category_confidence numeric(3,2) null` with `CHECK (category_confidence >= 0 and category_confidence <= 1)`
  - `categorized_at timestamptz null`
  - `is_deleted boolean not null default false`
  - `created_at timestamptz not null default now()`
  - `updated_at timestamptz not null default now()`

  Indexes and uniques:
  - Partial unique index on `(source_provider, external_id)` where `external_id` is not null (`uniq_fa_tx_provider_external_id`)
  - Column-level unique on `fingerprint_sha256`
  - B-tree index on `(date)` (`ix_fa_transactions_date`)
  - B-tree index on `(category)` (`ix_fa_transactions_category`)
  - B-tree index on `(merchant)` (`ix_fa_transactions_merchant`)

Categories are seeded by Alembic migrations in `libs/db/alembic/versions/` and
managed in the application via the `fa_categories` table (no in-repo constants).
